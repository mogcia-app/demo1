# 🔐 機材管理システム - 管理者向け操作マニュアル

**バージョン:** 1.0  
**最終更新日:** 2024年10月20日

---

## 📋 目次

1. [管理者権限について](#管理者権限について)
2. [管理者ログイン](#管理者ログイン)
3. [ダッシュボード](#ダッシュボード)
4. [機材管理](#機材管理)
5. [グループ管理](#グループ管理)
6. [担当者管理](#担当者管理)
7. [データのバックアップ](#データのバックアップ)
8. [トラブルシューティング](#トラブルシューティング)
9. [セキュリティ設定](#セキュリティ設定)

---

## 管理者権限について

### 管理者ができること

✅ **機材管理**
- 機材の追加・編集・削除
- 在庫総数の変更
- 機材情報の更新

✅ **グループ管理**
- 機材グループ（カテゴリ）の追加・編集・削除
- グループの並び替え

✅ **担当者管理**
- 担当者の追加・編集・削除
- 担当者の有効/無効の切り替え

✅ **データ管理**
- 全ユーザーのデータ確認
- システム設定の変更

### 一般ユーザーとの違い

| 機能 | 一般ユーザー | 管理者 |
|------|-------------|--------|
| 現場登録・編集・削除 | ✅ | ✅ |
| 機材の参照 | ✅ | ✅ |
| 機材の追加・編集 | ❌ | ✅ |
| グループの管理 | ❌ | ✅ |
| 担当者の管理 | ❌ | ✅ |
| 在庫数の変更 | ❌ | ✅ |

---

## 管理者ログイン

### ログイン方法

1. **管理者ログインページにアクセス**
   - URL: `https://<あなたのドメイン>/admin/login`
   - ⚠️ 通常のログインページ（`/login`）ではありません

2. **管理者用のメールアドレスとパスワードを入力**
   - 管理者として登録されたメールアドレスを使用
   - パスワードを入力

3. **「管理者としてログイン」ボタンをクリック**

```
┌─────────────────────────────┐
│  🔐 管理者ログイン           │
├─────────────────────────────┤
│                             │
│  📧 メールアドレス           │
│  [____________________]     │
│                             │
│  🔒 パスワード              │
│  [____________________]     │
│                             │
│  [管理者としてログイン]      │
│                             │
│         ← 戻る              │
└─────────────────────────────┘
```

### 管理者権限の確認

ログイン後、以下が表示されていれば管理者としてログイン成功：
- ヘッダーに「管理者」バッジが表示
- 管理者ダッシュボードが表示

### ⚠️ セキュリティ注意事項

- **管理者アカウントは厳重に管理**してください
- **パスワードは定期的に変更**してください
- **共有しない**: 管理者アカウントを他人と共有しない
- **ログアウトを忘れずに**: 作業終了後は必ずログアウト

---

## ダッシュボード

### 概要画面

管理者ダッシュボードには以下の統計情報が表示されます：

```
┌─────────────────────────────────────┐
│  管理者ダッシュボード                │
├─────────────────────────────────────┤
│                                     │
│  📅 登録現場数     📦 機材数        │
│     25件              42種類        │
│                                     │
│  📂 機材グループ数  👥 担当者数     │
│     8グループ         12人          │
│                                     │
└─────────────────────────────────────┘
```

### タブ構成

- **概要**: 統計情報
- **機材管理**: 機材のCRUD
- **グループ管理**: カテゴリのCRUD
- **担当者管理**: 担当者のCRUD

---

## 機材管理

### 機材を追加する

1. **「機材管理」タブを開く**

2. **「機材を追加」ボタンをクリック**

3. **機材情報を入力**

   #### 必須項目
   - **機材名**（必須）
     - 例: 「高所作業車」「発電機」
   
   - **カテゴリ**（複数選択可）
     - チェックボックスで該当するグループを選択
     - 複数のグループに所属させることが可能
   
   - **在庫数**（必須）
     - 初期在庫数を入力
     - 数値のみ（0以上）

   #### オプション項目
   - **説明**
     - 機材の詳細情報、仕様など
     - 例: 「最大作業高さ15m、積載重量200kg」

4. **「保存」ボタンをクリック**

### 💡 ポイント

- **機材番号は自動採番**: システムが自動的に次の番号を割り当てます
- **カテゴリなしも可能**: カテゴリを選択しなくても登録できます
- **後から編集可能**: 登録後も情報を変更できます

---

### 機材を編集する

1. **機材一覧から編集したい機材の「✏️ 編集」ボタンをクリック**

2. **情報を変更**
   - 機材名
   - カテゴリ
   - 在庫数
   - 説明

3. **「保存」ボタンをクリック**

### ⚠️ 注意事項：在庫数の変更

#### 在庫を増やす場合
- 問題なく変更できます
- 例: 10台 → 15台

#### 在庫を減らす場合
- **現在使用中の数量を下回ることはできません**
- 例: 在庫10台、使用中5台の場合
  - ✅ OK: 10台 → 8台（使用可能5台 → 3台）
  - ❌ NG: 10台 → 4台（使用中5台を下回る）

#### エラーが出た場合の対処法
1. 使用中の現場を確認
2. 現場を調整して使用数量を減らす
3. 在庫数を変更

---

### 機材を削除する

1. **機材一覧から削除したい機材の「🗑️ 削除」ボタンをクリック**

2. **確認メッセージが表示されます**
   ```
   この機材を削除しますか？
   
   [キャンセル]  [削除]
   ```

3. **「削除」ボタンをクリック**

### ⚠️ 重要な注意事項

- **使用中の機材は削除できません**
  - エラー: 「この機材は現在〇件の現場で使用中です」
  - 対処: すべての現場から削除してから機材を削除

- **削除は取り消せません**
  - データベースから完全に削除されます
  - 慎重に実行してください

---

## グループ管理

### グループとは

機材を分類するためのカテゴリです。

**例:**
- 重機
- 発電・電気
- 安全用品
- 測量機器
- 仮設資材

### グループを追加する

1. **「グループ管理」タブを開く**

2. **「グループを追加」ボタンをクリック**

3. **グループ名を入力**
   - 例: 「重機」「電気設備」「安全用品」

4. **「保存」ボタンをクリック**

### グループを編集する

1. **グループ一覧から「✏️ 編集」ボタンをクリック**

2. **グループ名を変更**

3. **「保存」ボタンをクリック**

### グループを削除する

1. **グループ一覧から「🗑️ 削除」ボタンをクリック**

2. **確認メッセージが表示されます**
   ```
   グループ「〇〇」には5個の機材が登録されています。
   削除すると機材のカテゴリが未設定になります。
   本当に削除しますか？
   
   [キャンセル]  [削除]
   ```

3. **「削除」ボタンをクリック**

### ⚠️ 注意事項

- **機材は削除されません**: グループを削除しても機材自体は残ります
- **カテゴリが未設定になる**: そのグループに属していた機材はカテゴリなしになります
- **再分類が必要**: 機材を別のグループに再分類する必要があります

---

## 担当者管理

### 担当者を追加する

1. **「担当者管理」タブを開く**

2. **「担当者を追加」ボタンをクリック**

3. **担当者情報を入力**
   - **名前**（必須）
     - 例: 「田中太郎」「鈴木花子」
   
   - **有効**
     - チェックを入れると現場登録時に選択可能
     - チェックを外すと選択不可（退職者など）

4. **「保存」ボタンをクリック**

### 担当者を編集する

1. **担当者一覧から「✏️ 編集」ボタンをクリック**

2. **情報を変更**
   - 名前
   - 有効/無効

3. **「保存」ボタンをクリック**

### 担当者を無効化する

退職者など、システムから削除せずに非表示にする場合：

1. **担当者を編集**

2. **「有効」のチェックを外す**

3. **「保存」ボタンをクリック**

**結果:**
- ✅ 既存の現場データはそのまま残る
- ✅ 過去の担当者名も表示される
- ❌ 新しい現場には選択できなくなる

### 担当者を削除する

1. **担当者一覧から「🗑️ 削除」ボタンをクリック**

2. **確認メッセージが表示されます**

3. **「削除」ボタンをクリック**

### ⚠️ 注意事項

- **使用中の担当者は削除できません**
  - エラー: 「この担当者は〇件の現場で使用中です」
  - 推奨: 削除ではなく「無効化」を使用

- **データの整合性**: 削除すると過去のデータから担当者名が消えます
- **推奨**: 基本的に「無効化」を使用し、削除は避ける

---

## データのバックアップ

### Firestoreからのエクスポート

1. **Firebaseコンソールにアクセス**
   - https://console.firebase.google.com

2. **プロジェクトを選択**

3. **Firestore Database → データのエクスポート**

4. **バケットを選択して「エクスポート」実行**

### バックアップの推奨頻度

- **毎日**: 自動バックアップ設定を推奨
- **重要な作業前**: 手動バックアップ
- **月末**: 定期バックアップ

---

## トラブルシューティング（管理者向け）

### 問題: ユーザーがログインできない

#### 確認事項

1. **Firebaseコンソールで確認**
   - Authentication → Users
   - ユーザーが登録されているか確認

2. **メールアドレスの確認**
   - スペースや全角文字がないか
   - 正しく登録されているか

3. **アカウントが無効化されていないか**
   - Firebase Authenticationで確認

#### 解決方法

**方法1: パスワードリセット（Firebaseコンソール）**
1. Firebase Console → Authentication → Users
2. 該当ユーザーを選択
3. 「パスワードをリセット」をクリック
4. 新しいパスワードを設定

**方法2: 新しいアカウントを作成**
1. Firebase Console → Authentication → Users
2. 「ユーザーを追加」をクリック
3. メールアドレスとパスワードを入力
4. 「ユーザーを追加」をクリック

---

### 問題: 在庫数がおかしい

#### 症状
- 在庫がマイナスになっている
- 在庫数が実際と合わない

#### 原因
- トランザクションエラー
- 手動でデータを変更した
- システムエラー

#### 解決方法

1. **現在の使用状況を確認**
   - すべての現場を確認
   - 各機材の使用合計を計算

2. **正しい在庫数を計算**
   ```
   正しい在庫数 = 実際の総数 - 使用中の数
   ```

3. **管理者画面で在庫数を修正**
   - 機材管理 → 該当機材を編集
   - 正しい在庫数を入力
   - 保存

4. **Firestoreで直接修正（最終手段）**
   - Firebase Console → Firestore Database
   - equipment コレクション → 該当ドキュメント
   - stock フィールドを修正

---

### 問題: Googleカレンダーに同期されない

#### 確認事項

1. **環境変数の確認**
   - Vercel Dashboard → Settings → Environment Variables
   - `NEXT_PUBLIC_GOOGLE_CALENDAR_API_KEY` が設定されているか

2. **Googleカレンダー APIの確認**
   - Google Cloud Console で APIが有効になっているか
   - APIキーが有効か
   - 使用量制限に達していないか

3. **ブラウザのコンソールエラーを確認**
   - F12キー → Console タブ
   - エラーメッセージを確認

#### 解決方法

1. **APIキーを再生成**
   - Google Cloud Console → 認証情報
   - 新しいAPIキーを生成
   - Vercelの環境変数を更新
   - Redeploy

2. **APIの再有効化**
   - Google Cloud Console → API とサービス
   - Google Calendar API を無効化
   - 再度有効化

---

### 問題: デプロイ後にエラーが発生

#### 確認事項

1. **Vercelのデプロイログを確認**
   - Vercel Dashboard → Deployments
   - 最新のデプロイをクリック
   - Build Logs を確認

2. **環境変数の確認**
   - すべての環境変数が設定されているか
   - 値が正しいか（スペース、改行がないか）

3. **Firebaseセキュリティルールの確認**
   - Firebase Console → Firestore Database → Rules
   - ルールが正しく設定されているか

#### 解決方法

**ビルドエラーの場合:**
1. ローカルで `npm run build` を実行
2. エラーを修正
3. Git にコミット＆プッシュ

**実行時エラーの場合:**
1. Vercelのログを確認
2. 環境変数を再確認
3. Redeploy

---

### 問題: 機材が削除できない

#### 症状
- 「この機材は使用中です」というエラー

#### 確認方法

1. **使用中の現場を確認**
   ```
   現場一覧で該当機材を検索
   ```

2. **Firestoreで確認（詳細）**
   - Firebase Console → Firestore
   - events コレクション
   - equipment フィールドで該当機材IDを検索

#### 解決方法

1. **使用中の現場から機材を削除**
   - 各現場を編集
   - 該当機材を削除
   - 保存

2. **現場ごと削除（慎重に）**
   - 不要な現場を削除
   - 機材の在庫が自動復元

3. **すべての現場から削除後、機材を削除**

---

## セキュリティ設定

### Firestore セキュリティルール

#### 基本ルール

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 認証済みユーザーのみ読み書き可能
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

#### より厳密なルール（推奨）

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 認証済みユーザーは読み取り可能
    match /{document=**} {
      allow read: if request.auth != null;
    }
    
    // 現場データ: 認証済みユーザーが作成・更新・削除可能
    match /events/{eventId} {
      allow create, update, delete: if request.auth != null;
    }
    
    // 機材データ: 読み取りは全員、書き込みは管理者のみ
    match /equipment/{equipmentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                     request.auth.token.email in [
                       'admin@example.com'
                     ];
    }
    
    // グループ・担当者: 管理者のみ書き込み可能
    match /equipmentCategories/{categoryId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                     request.auth.token.email in [
                       'admin@example.com'
                     ];
    }
    
    match /assignees/{assigneeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                     request.auth.token.email in [
                       'admin@example.com'
                     ];
    }
  }
}
```

### 管理者メールアドレスの管理

#### 現在の設定（`lib/auth.ts`）

```typescript
export const isAdminUser = (user: User | null): boolean => {
  if (!user?.email) return false
  
  const adminEmails = [
    'admin@example.com',
    // 他の管理者メールアドレスをここに追加
  ]
  
  return adminEmails.includes(user.email.toLowerCase())
}
```

#### 管理者を追加する方法

1. **コードを編集**
   - `lib/auth.ts` ファイルを開く
   - `adminEmails` 配列に新しいメールアドレスを追加
   - 例: `'newadmin@example.com'`

2. **Gitにコミット＆プッシュ**
   ```bash
   git add lib/auth.ts
   git commit -m "管理者追加"
   git push origin main
   ```

3. **自動デプロイ完了を待つ**

#### ⚠️ セキュリティ上の注意

- **環境変数で管理する方法もあります**（より安全）
- **管理者は最小限に**: 必要な人だけに権限を付与
- **定期的に見直し**: 退職者の権限を削除

---

### 認証済みドメインの設定

#### 本番環境を追加

1. **Firebaseコンソールにアクセス**
   - https://console.firebase.google.com

2. **Authentication → Settings → Authorized domains**

3. **ドメインを追加**
   - Vercelの本番ドメイン: `<yourapp>.vercel.app`
   - カスタムドメイン（ある場合）

4. **「追加」をクリック**

---

## 定期メンテナンス

### 毎日

- [ ] システムが正常に動作しているか確認
- [ ] ユーザーからの問い合わせ対応

### 毎週

- [ ] データのバックアップ確認
- [ ] エラーログの確認（Vercel Dashboard）
- [ ] 在庫数の確認・調整

### 毎月

- [ ] 機材リストの見直し
- [ ] 担当者リストの見直し
- [ ] 不要なデータの整理
- [ ] パフォーマンスの確認

### 四半期ごと

- [ ] セキュリティ設定の見直し
- [ ] 管理者アカウントの見直し
- [ ] システム全体の最適化
- [ ] ユーザーフィードバックの収集と改善

---

## 緊急時の対応

### システムダウン

1. **Vercelのステータス確認**
   - https://www.vercel-status.com

2. **Firebaseのステータス確認**
   - https://status.firebase.google.com

3. **デプロイログの確認**
   - Vercel Dashboard → Deployments

4. **ロールバック**
   - Vercel Dashboard → Deployments
   - 前回の成功したデプロイを選択
   - 「Redeploy」をクリック

### データ消失

1. **バックアップから復元**
   - Firebaseコンソール
   - Cloud Storage からバックアップを取得
   - インポート実行

2. **直近のデプロイから復元**
   - Vercelの前回のデプロイに戻す

---

## サポート・連絡先

### Firebase サポート
- https://firebase.google.com/support

### Vercel サポート
- https://vercel.com/support

### 開発者連絡先
- [開発者の連絡先を記入]

---

**このマニュアルは管理者のみに配布してください。**  
**外部への共有は禁止します。**


